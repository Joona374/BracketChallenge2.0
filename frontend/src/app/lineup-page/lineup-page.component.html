<!-- New container for top section -->
<div class="lineup-top-container">
  <!-- Left side: player slots -->
  <div class="lineup-wrapper">
    <h2 class="section-header">
      {{
        lineupLocked
          ? "Tee muutoksia kokoonpanoon"
          : "Valitse Aloituskokoonpano"
      }}
      <app-tooltip
        text="Valitse 6 pelaajan kokoonpano: 3 hy√∂kk√§√§j√§√§ (VL, KH, OL), 2 puolustajaa (VP, OP) ja maalivahti (MV). Kokonaisbudjetti on $2,000,000. Ennen deadlinea voit vaihtaa pelaajia vapaasti. Deadlinen j√§lkeen sinulla on k√§yt√∂ss√§si 9 vaihtoa kokoonpanon muokkaamiseen."
      ></app-tooltip>
    </h2>

    <div class="slot-container">
      <!-- Forwards -->
      <div class="lineup-row forwards">
        <div
          *ngFor="let slot of forwardSlots"
          class="slot"
          [ngClass]="getPlayerClass(slot)"
          [class.active]="selectedSlot === slot"
          (click)="onSlotClick(slot)"
        >
          <span>{{ formatPlayer(slot) }}</span>
        </div>
      </div>

      <!-- Defenders -->
      <div class="lineup-row defenders">
        <div class="spacer"></div>
        <div
          *ngFor="let slot of defenderSlots"
          class="slot"
          [ngClass]="getPlayerClass(slot)"
          [class.active]="selectedSlot === slot"
          (click)="onSlotClick(slot)"
        >
          <span>{{ formatPlayer(slot) }}</span>
        </div>
      </div>

      <!-- Goalie -->
      <div class="lineup-row goalie">
        <div class="spacer"></div>
        <div class="spacer"></div>
        <div
          class="slot"
          [ngClass]="getPlayerClass(goalieSlot)"
          [class.active]="selectedSlot === goalieSlot"
          (click)="onSlotClick(goalieSlot)"
        >
          <span>{{ formatPlayer(goalieSlot) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Right side: budget and controls -->
  <div class="lineup-side-panel">
    <!-- Budget display -->
    <div class="budget-display">
      <span class="budget-label">Budjettia J√§ljell√§:</span>
      <span
        class="budget-value"
        [ngClass]="{ 'budget-warning': remainingBudget < 500000 }"
      >
        {{ formatPrice(remainingBudget) }}
      </span>
    </div>

    <!-- Trade counter display -->
    <div class="trades-display" *ngIf="lineupLocked">
      <span class="trades-label">Vaihtoja J√§ljell√§:</span>
      <span
        class="trades-value"
        [ngClass]="{ 'trades-warning': effectiveRemainingTrades < 3 }"
      >
        {{ effectiveRemainingTrades }}/{{ maxTrades }}
      </span>
    </div>

    <!-- Controls -->
    <div class="controls">
      <button class="lineup-button save" (click)="saveLineup()">
        üíæ Tallenna Kokoonpano
      </button>
      <button
        *ngIf="!lineupLocked"
        class="lineup-button clear"
        (click)="clearLineup()"
      >
        üßπ Tyhenn√§ Kokoonpano
      </button>
      <button
        *ngIf="lineupLocked"
        class="lineup-button reset"
        (click)="resetLineup()"
      >
        ‚Ü∫ Palauta Kokoonpano
      </button>
      <input
        type="text"
        placeholder="Hae pelaajan tai joukkueen nimell√§..."
        [(ngModel)]="searchTerm"
        class="search-box"
      />
    </div>
  </div>
</div>

<!-- Scrollable Player Table -->
<div class="player-table-container">
  <table class="player-table">
    <thead>
      <tr>
        <!-- Common headers -->
        <th
          (click)="sortBy('position')"
          [class.sorted]="sortKey === 'position'"
          style="width: 75px"
        >
          Pelip.
          <span *ngIf="sortKey === 'position'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
        <th
          (click)="sortBy('firstName')"
          [class.sorted]="sortKey === 'firstName'"
          class="hide-on-mobile"
        >
          Etunimi
          <span *ngIf="sortKey === 'firstName'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
        <th
          (click)="sortBy('lastName')"
          [class.sorted]="sortKey === 'lastName'"
        >
          Sukunimi
          <span *ngIf="sortKey === 'lastName'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
        <th (click)="sortBy('team')" [class.sorted]="sortKey === 'team'">
          Joukkue
          <span *ngIf="sortKey === 'team'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
        <th
          (click)="sortBy('isU23')"
          [class.sorted]="sortKey === 'isU23'"
          class="hide-on-mobile"
        >
          U23
          <span *ngIf="sortKey === 'isU23'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
        <th
          (click)="sortBy('reg_gp')"
          [class.sorted]="sortKey === 'reg_gp'"
          class="stat-column hide-on-mobile"
        >
          Pelattu
          <span *ngIf="sortKey === 'reg_gp'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>

        <!-- Skater-specific headers (show when not in goalie mode) -->
        <ng-container *ngIf="!isGoalieSlotSelected()">
          <th
            (click)="sortBy('reg_goals')"
            [class.sorted]="sortKey === 'reg_goals'"
            class="stat-column"
          >
            Maalit
            <span *ngIf="sortKey === 'reg_goals'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_assists')"
            [class.sorted]="sortKey === 'reg_assists'"
            class="stat-column"
          >
            Sy√∂t√∂t
            <span *ngIf="sortKey === 'reg_assists'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_points')"
            [class.sorted]="sortKey === 'reg_points'"
            class="stat-column"
          >
            Pisteet
            <span *ngIf="sortKey === 'reg_points'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_plus_minus')"
            [class.sorted]="sortKey === 'reg_plus_minus'"
            class="stat-column hide-on-mobile"
          >
            +/-
            <span *ngIf="sortKey === 'reg_plus_minus'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
        </ng-container>

        <!-- Goalie-specific headers (show when in goalie mode) -->
        <ng-container *ngIf="isGoalieSlotSelected()">
          <th
            (click)="sortBy('reg_wins')"
            [class.sorted]="sortKey === 'reg_wins'"
            class="stat-column"
          >
            Voitot
            <span *ngIf="sortKey === 'reg_wins'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_shutouts')"
            [class.sorted]="sortKey === 'reg_shutouts'"
            class="stat-column hide-on-mobile"
          >
            Nollapelit
            <span *ngIf="sortKey === 'reg_shutouts'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_save_pct')"
            [class.sorted]="sortKey === 'reg_save_pct'"
            class="stat-column"
          >
            T%
            <span *ngIf="sortKey === 'reg_save_pct'">{{
              sortAsc ? "‚ñ≤" : "‚ñº"
            }}</span>
          </th>
          <th
            (click)="sortBy('reg_gaa')"
            [class.sorted]="sortKey === 'reg_gaa'"
            class="stat-column"
          >
            PMK
            <span *ngIf="sortKey === 'reg_gaa'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
          </th>
        </ng-container>

        <!-- Common footer headers -->
        <th (click)="sortBy('price')" [class.sorted]="sortKey === 'price'">
          Hinta
          <span *ngIf="sortKey === 'price'">{{ sortAsc ? "‚ñ≤" : "‚ñº" }}</span>
        </th>
      </tr>
    </thead>

    <tbody>
      <tr
        *ngFor="let entity of availablePlayers"
        (click)="assignPlayerToSlot(entity)"
        class="player-row"
      >
        <td>{{ entity?.position || "" }}</td>
        <td class="hide-on-mobile">{{ entity?.firstName || "" }}</td>
        <td>{{ entity?.lastName || "" }}</td>
        <td>{{ entity?.team || "" }}</td>
        <td class="hide-on-mobile">{{ entity?.isU23 ? "‚úì" : "‚ùå" }}</td>
        <td class="stat-column hide-on-mobile">{{ entity?.reg_gp || 0 }}</td>

        <!-- Player-specific stats -->
        <ng-container *ngIf="!isGoalieSlotSelected()">
          <td class="stat-column">{{ getPlayerStats(entity, "reg_goals") }}</td>
          <td class="stat-column">
            {{ getPlayerStats(entity, "reg_assists") }}
          </td>
          <td class="stat-column">
            {{ getPlayerStats(entity, "reg_points") }}
          </td>
          <td
            class="stat-column hide-on-mobile"
            [class.positive]="getPlayerStats(entity, 'reg_plus_minus') > 0"
            [class.negative]="getPlayerStats(entity, 'reg_plus_minus') < 0"
          >
            {{ getPlayerStats(entity, "reg_plus_minus") > 0 ? "+" : ""
            }}{{ getPlayerStats(entity, "reg_plus_minus") }}
          </td>
        </ng-container>

        <!-- Goalie-specific stats -->
        <ng-container *ngIf="isGoalieSlotSelected()">
          <td class="stat-column">{{ getGoalieStats(entity, "reg_wins") }}</td>
          <td class="stat-column hide-on-mobile">
            {{ getGoalieStats(entity, "reg_shutouts") }}
          </td>
          <td
            class="stat-column"
            [class.positive]="getGoalieStats(entity, 'reg_save_pct') > 0.915"
            [class.negative]="getGoalieStats(entity, 'reg_save_pct') < 0.9"
          >
            {{ formatSavePercentage(entity) }}
          </td>
          <td
            class="stat-column"
            [class.positive]="getGoalieStats(entity, 'reg_gaa') < 2.5"
            [class.negative]="getGoalieStats(entity, 'reg_gaa') >= 3.0"
          >
            {{ formatGAA(entity) }}
          </td>
        </ng-container>

        <td>{{ formatPrice(entity?.price || 0) }}</td>
      </tr>
    </tbody>
  </table>
</div>
