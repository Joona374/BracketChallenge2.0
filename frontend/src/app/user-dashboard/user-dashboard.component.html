<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="user-profile">
      <div
        class="avatar-circle"
        (click)="openLogoSelectionModal()"
        title="Click to change logo"
      >
        <!-- Show team logo if available, fallback to initials -->
        <img
          *ngIf="user && user.logoUrl"
          [src]="user.logoUrl"
          class="team-logo"
          alt="Team Logo"
        />
        <span *ngIf="!(user && user.logoUrl)" class="initials">{{
          getUserInitials()
        }}</span>

        <!-- Add hover indicator to show it's clickable -->
        <div class="edit-overlay">
          <span class="edit-icon">✎</span>
        </div>
      </div>
      <div class="user-info">
        <h1>{{ user?.username || "User" }} Profiili</h1>
        <h2>{{ user?.teamName || "Team Name Not Set" }}</h2>
      </div>
    </div>

    <div class="rank-display">
      <span class="rank-label">Sija</span>
      <span class="rank-value">#{{ userRank || "-" }}</span>
    </div>

    <div class="points-summary">
      <div class="total-points">
        <span class="points-value">{{ points.total }}</span>
        <span class="points-label">KOKONAIS PISTEET</span>
      </div>
      <div class="points-breakdown">
        <div class="point-category">
          <span class="category-name">Bracket</span>
          <span class="category-points">{{ points.bracket }}</span>
        </div>
        <div class="point-category">
          <span class="category-name">Kokoonpano</span>
          <span class="category-points">{{ points.lineup }}</span>
        </div>
        <div class="point-category">
          <span class="category-name">Top 3 Pelaajat</span>
          <span class="category-points">{{ points.predictions }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="dashboard-content">
    <!-- Bracket Summary Card -->
    <div class="dashboard-card bracket-card">
      <div class="card-header">
        <h3>Playoff-kaavio</h3>
        <button routerLink="/bracket" class="action-link">Muokkaa</button>
      </div>

      <div class="card-content">
        <div class="bracket-summary">
          <!-- Picks Table -->
          <div class="bracket-table-section">
            <h4 class="table-title">Oikeat Valinnat</h4>
            <div class="round-stats-header">
              <div class="round-header-item">Kierros</div>
              <div class="round-header-item">Sinun</div>
              <div class="round-header-item">Keskim.</div>
              <div class="round-header-item">Paras</div>
            </div>

            <div class="round-stats">
              <div
                class="round-row"
                *ngFor="let round of bracketSummary.rounds"
              >
                <div class="round-name">{{ round.name }}</div>
                <div
                  class="round-metric"
                  [class.highlight]="round.correct > round.avgCorrect"
                >
                  {{ round.correct }}
                </div>
                <div class="round-metric">
                  {{ round.avgCorrect }}
                </div>
                <div class="round-metric best">
                  {{ round.bestCorrect }}
                </div>
              </div>
            </div>

            <div class="round-stats-total">
              <div class="total-label">Yhteensä</div>
              <div
                class="total-value"
                [class.highlight]="
                  bracketSummary.totalCorrect > bracketSummary.avgTotalCorrect
                "
              >
                {{ bracketSummary.totalCorrect }}
              </div>
              <div class="total-value">
                {{ bracketSummary.avgTotalCorrect }}
              </div>
              <div class="total-value best">
                {{ bracketSummary.bestTotalCorrect }}
              </div>
            </div>
          </div>

          <!-- Points Table -->
          <div class="bracket-table-section">
            <h4 class="table-title">Pisteet</h4>
            <div class="round-stats-header">
              <div class="round-header-item">Kierros</div>
              <div class="round-header-item">Sinun</div>
              <div class="round-header-item">Keskim.</div>
              <div class="round-header-item">Paras</div>
            </div>

            <div class="round-stats">
              <div
                class="round-row"
                *ngFor="let round of bracketSummary.rounds"
              >
                <div class="round-name">{{ round.name }}</div>
                <div
                  class="round-metric"
                  [class.highlight]="round.points > round.avgPoints"
                >
                  {{ round.points }}
                </div>
                <div class="round-metric">
                  {{ round.avgPoints }}
                </div>
                <div class="round-metric best">
                  {{ round.bestPoints }}
                </div>
              </div>
            </div>

            <div class="round-stats-total">
              <div class="total-label">Yhteensä</div>
              <div
                class="total-value"
                [class.highlight]="
                  points.bracket > bracketSummary.avgTotalPoints
                "
              >
                {{ points.bracket }}
              </div>
              <div class="total-value">
                {{ bracketSummary.avgTotalPoints }}
              </div>
              <div class="total-value best">
                {{ bracketSummary.bestTotalPoints }}
              </div>
            </div>
          </div>

          <!-- Matchup Comparison Tables -->
          <div class="bracket-matchups-section">
            <h4 class="table-title">Ottelut</h4>

            <div
              class="round-matchups"
              *ngFor="let round of bracketSummary.roundMatchups"
            >
              <div class="round-title">{{ round.name }}</div>

              <table class="matchup-table">
                <thead>
                  <tr>
                    <th>Valinta</th>
                    <th>Tulos</th>
                    <th>Enn. Pelit</th>
                    <th>Tot. Pelit</th>
                  </tr>
                </thead>
                <tbody>
                  <tr
                    *ngFor="let matchup of round.matchups"
                    [class.correct-pick]="matchup.userCorrect"
                  >
                    <td class="team-cell">
                      <span
                        class="team-abbr {{
                          matchup.userPickedTeam.toLowerCase()
                        }}"
                      >
                        {{ matchup.userPickedTeam }}
                      </span>
                    </td>
                    <td class="team-cell">
                      <span
                        class="team-abbr {{
                          matchup.actualWinner.toLowerCase()
                        }}"
                      >
                        {{ matchup.actualWinner }}
                      </span>
                    </td>
                    <td class="games-cell">
                      {{ matchup.userPickedGames }}
                    </td>
                    <td
                      class="games-cell"
                      [class.correct]="matchup.gamesCorrect"
                    >
                      {{ matchup.actualGames > 0 ? matchup.actualGames : "-" }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card-stats">
          <div class="stat-item">
            <span class="stat-value">{{ points.bracket }}</span>
            <span class="stat-label">Pisteet</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Lineup Summary Card -->
    <div class="dashboard-card lineup-card">
      <div class="card-header">
        <h3>Kokoonpano</h3>
        <button routerLink="/lineup" class="action-link">Muokkaa</button>
      </div>

      <div class="card-content">
        <div class="lineup-details">
          <div class="lineup-info">
            <div class="budget-detail">
              <span class="detail-label">Kokonaisarvo:</span>
              <span
                class="detail-value"
                [class.value-high]="
                  lineupSummary.totalValue + lineupSummary.unusedBudget >
                  2000000
                "
                >{{
                  formatCurrency(
                    lineupSummary.totalValue + lineupSummary.unusedBudget
                  )
                }}</span
              >
            </div>
            <div class="budget-detail">
              <span class="detail-label">Budjetti Jäljellä:</span>
              <span
                class="detail-value"
                [class.value-low]="lineupSummary.unusedBudget < 30000"
                >{{ formatCurrency(lineupSummary.unusedBudget) }}</span
              >
            </div>
            <div class="budget-detail">
              <span class="detail-label">Vaihtoja Jäljellä:</span>
              <span
                class="detail-value"
                [class.value-low]="lineupSummary.remainingTrades <= 0"
                >{{ lineupSummary.remainingTrades }}</span
              >
            </div>
          </div>
          <div class="player-grid">
            <div
              *ngFor="let position of ['VL', 'KH', 'OL', 'VP', 'OP', 'MV']"
              class="player-slot"
            >
              <span class="position-label">{{ position }}:</span>
              <span
                class="player-name"
                *ngIf="getPlayerByPosition(position) as player"
              >
                {{ player.firstName }} {{ player.lastName }}
                <span class="player-price">{{
                  formatCurrency(player.price)
                }}</span>
              </span>
              <span class="empty-slot" *ngIf="!getPlayerByPosition(position)"
                >Tyhjä</span
              >
            </div>
          </div>

          <!-- Trade History Section -->
          <div class="trade-history">
            <h4 class="section-title">Vaihtohistoria</h4>
            <div class="trade-header">
              <div class="trade-column-header">Pois</div>
              <div class="trade-arrow"></div>
              <div class="trade-column-header">Sisään</div>
            </div>
            <div class="trade-list">
              <div
                class="trade-item"
                *ngFor="let trade of lineupSummary.tradeHistory"
              >
                <div class="trade-date">{{ trade.date }}</div>
                <div class="trade-out">
                  <span class="player-out">{{ trade.playerOut }}</span>
                </div>
                <div class="trade-arrow">→</div>
                <div class="trade-in">
                  <span class="player-in">{{ trade.playerIn }}</span>
                </div>
                <div class="position-badge">{{ trade.positionOut }}</div>
              </div>
              <div
                class="no-trades"
                *ngIf="!lineupSummary.tradeHistory?.length"
              >
                Ei vaihtoja vielä
              </div>
            </div>
          </div>
        </div>

        <div class="card-stats">
          <div class="stat-item">
            <span class="stat-value">{{ points.lineup }}</span>
            <span class="stat-label">Pisteet</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Predictions Summary Card -->
    <div class="dashboard-card predictions-card">
      <div class="card-header">
        <h3>Top 3 Pelaajat</h3>
        <button routerLink="/predictions" class="action-link">Muokkaa</button>
      </div>

      <div class="card-content">
        <div class="stat-categories">
          <div class="category-header">
            <div class="category-title">Tämän hetkiset johtajat</div>
            <div class="prediction-results">
              <span>Oikein</span> / <span>Yhteensä</span>
            </div>
          </div>

          <div
            class="stat-category"
            *ngFor="let category of predictionsSummary.categories"
          >
            <div class="category-header-row">
              <div class="category-name">
                {{ getCategoryLabel(category.name) }}
              </div>
              <div class="category-score">
                <span [class.highlight]="category.correctPicks > 0">
                  {{ category.correctPicks }}/3
                </span>
              </div>
            </div>

            <div class="player-picks">
              <div class="pick-side user-picks">
                <div class="side-header">Sinun valinnat</div>
                <div
                  class="player-pick"
                  *ngFor="let player of category.userPicks"
                  [class.matching-pick]="
                    isPlayerInList(player, category.currentTop3)
                  "
                >
                  {{ player.firstName }} {{ player.lastName }}
                </div>
                <div
                  class="player-pick empty"
                  *ngIf="category.userPicks.length < 3"
                >
                  Valinnat puuttuu
                </div>
              </div>

              <div class="pick-side current-top">
                <div class="side-header">Nykyiset top 3</div>
                <div
                  class="player-pick"
                  *ngFor="let player of category.currentTop3"
                  [class.matching-pick]="
                    isPlayerInList(player, category.userPicks)
                  "
                >
                  {{ player.firstName }} {{ player.lastName }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="prediction-summary">
          <div class="summary-stat">
            <span class="summary-label">Yhteensä oikein tällä hetkellä:</span>
            <span class="summary-value"
              >{{ predictionsSummary.totalCorrect }}/18</span
            >
          </div>
        </div>

        <div class="prediction-details">
          <h4 class="section-title">Ennustuspisteet kierroksittain</h4>
          <div class="rounds-points">
            <div class="round-point">
              <span class="round-label">K1:</span>
              <span class="round-value">{{ points.predictionsR1 || 0 }}</span>
            </div>
            <div class="round-point">
              <span class="round-label">K2:</span>
              <span class="round-value">{{ points.predictionsR2 || 0 }}</span>
            </div>
            <div class="round-point">
              <span class="round-label">K3:</span>
              <span class="round-value">{{ points.predictionsR3 || 0 }}</span>
            </div>
            <div class="round-point">
              <span class="round-label">Finaali:</span>
              <span class="round-value">{{
                points.predictionsFinal || 0
              }}</span>
            </div>
          </div>
        </div>

        <div class="card-stats">
          <div class="stat-item">
            <span class="stat-value">{{ points.predictions }}</span>
            <span class="stat-label">Pisteet</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Logo Selection Modal -->
  <app-logo-selection
    *ngIf="showLogoSelectionModal"
    (closeModal)="closeLogoSelectionModal()"
    (logoSelected)="handleLogoSelected($event)"
  >
  </app-logo-selection>
</div>
