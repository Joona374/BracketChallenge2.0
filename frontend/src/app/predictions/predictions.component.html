<h2 class="section-header">
  Top 3 Pelaajien Veikkaus
  <app-tooltip
    text="Valitse jokaiseen kategoriaan kolme (3) mielestÃ¤si parasta pelaajaa.
    Pelaajien jÃ¤rjestyksellÃ¤ ei ole vÃ¤liÃ¤.
    Kun olet valinnut kaikkiin kategorioihin pelaajat, voit tallentaa veikkauksesi. Valintoja voi vaihtaa aina veikkausten lukkiutumiseen saakka!"
  ></app-tooltip>
</h2>

<!-- Deadline status indicator -->
<div *ngIf="deadlinePassed" class="deadline-notice">
  <span class="lock-icon">ðŸ”’</span> Veikkaukset ovat lukittu - aikaraja on
  umpeutunut (20.4.2025 00:00)
</div>

<p class="section-subheader">Valitse 3 pelaajaa jokaiseen kategoriaan</p>

<div class="predictions-container">
  <!-- Mobile Category Dropdown -->
  <div class="category-dropdown">
    <select
      class="category-select"
      [(ngModel)]="selectedCategory"
      [disabled]="deadlinePassed"
    >
      <option
        *ngFor="let cat of predictions | keyvalue"
        [value]="cat.key"
        [disabled]="deadlinePassed"
      >
        {{ categoryLabels[castToPredictionCategory(cat.key)] }}
        ({{ cat.value.length }}/3)
      </option>
    </select>
  </div>

  <!-- Category selection tabs -->
  <div class="category-tabs">
    <div
      *ngFor="let cat of predictions | keyvalue"
      class="category-tab"
      [class.active]="selectedCategory === cat.key"
      [class.completed]="cat.value.length === 3"
      [class.locked]="deadlinePassed"
      (click)="changeCategory(castToPredictionCategory(cat.key))"
    >
      {{ categoryLabels[castToPredictionCategory(cat.key)] }}
      <span class="pick-count">{{ cat.value.length }}/3</span>
    </div>
  </div>

  <div class="predictions-content">
    <!-- Left side: Current picks -->
    <div class="current-picks-panel">
      <div class="current-picks-header">
        <h3>{{ categoryLabels[selectedCategory] }}</h3>
      </div>
      <div class="picks-list">
        <!-- No picks message -->

        <!-- Player picks first -->
        <div
          *ngFor="let player of predictions[selectedCategory]; let i = index"
          class="pick-item"
          [ngClass]="'team-' + player.team.toLowerCase()"
        >
          <div class="pick-player-info">
            <div class="player-name">
              {{ player.firstName }} {{ player.lastName }}
            </div>
            <div class="player-details">
              {{ player.position }} | {{ player.team }}
            </div>
          </div>
          <button
            class="remove-pick"
            (click)="removePlayer(selectedCategory, i)"
            [disabled]="deadlinePassed"
          >
            âœ•
          </button>
        </div>

        <!-- Empty slots after player picks -->
        <div class="empty-slots">
          <div
            *ngFor="
              let _ of [].constructor(3 - predictions[selectedCategory].length);
              let i = index
            "
            class="empty-slot"
          >
            TyhjÃ¤...
          </div>
        </div>
        <div
          *ngIf="predictions[selectedCategory].length === 0"
          class="no-picks"
        >
          Ei vielÃ¤ valittuja pelaajia
        </div>
      </div>
    </div>

    <!-- Right side: Player selection -->
    <div class="player-selection-panel" [class.disabled]="deadlinePassed">
      <div class="search-controls">
        <input
          type="text"
          placeholder="Hae pelaajia..."
          [(ngModel)]="searchTerm"
          class="search-box"
          [disabled]="deadlinePassed"
        />
      </div>

      <!-- Player table -->
      <div class="player-table-container">
        <table class="player-table">
          <thead>
            <tr>
              <th
                style="max-width: 50px"
                (click)="sortBy('position')"
                [class.sorted]="sortKey === 'position'"
              >
                Pelip.
                <span *ngIf="sortKey === 'position'">{{
                  sortAsc ? "â–²" : "â–¼"
                }}</span>
              </th>
              <th
                (click)="sortBy('firstName')"
                [class.sorted]="sortKey === 'firstName'"
              >
                Etunimi
                <span *ngIf="sortKey === 'firstName'">{{
                  sortAsc ? "â–²" : "â–¼"
                }}</span>
              </th>
              <th
                (click)="sortBy('lastName')"
                [class.sorted]="sortKey === 'lastName'"
              >
                Sukunimi
                <span *ngIf="sortKey === 'lastName'">{{
                  sortAsc ? "â–²" : "â–¼"
                }}</span>
              </th>
              <th (click)="sortBy('team')" [class.sorted]="sortKey === 'team'">
                Joukkue
                <span *ngIf="sortKey === 'team'">{{
                  sortAsc ? "â–²" : "â–¼"
                }}</span>
              </th>

              <!-- GP column always shown for both players and goalies -->
              <th
                (click)="sortBy('reg_gp')"
                [class.sorted]="sortKey === 'reg_gp'"
                class="stat-column"
              >
                OTT
                <span *ngIf="sortKey === 'reg_gp'">{{
                  sortAsc ? "â–²" : "â–¼"
                }}</span>
              </th>

              <!-- Skater specific columns -->
              <ng-container *ngIf="selectedCategory !== 'goalieWins'">
                <th
                  (click)="sortBy('reg_goals')"
                  [class.sorted]="sortKey === 'reg_goals'"
                  class="stat-column"
                >
                  M
                  <span *ngIf="sortKey === 'reg_goals'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_assists')"
                  [class.sorted]="sortKey === 'reg_assists'"
                  class="stat-column"
                >
                  S
                  <span *ngIf="sortKey === 'reg_assists'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_points')"
                  [class.sorted]="sortKey === 'reg_points'"
                  class="stat-column"
                >
                  P
                  <span *ngIf="sortKey === 'reg_points'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_plus_minus')"
                  [class.sorted]="sortKey === 'reg_plus_minus'"
                  class="stat-column"
                >
                  +/-
                  <span *ngIf="sortKey === 'reg_plus_minus'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
              </ng-container>

              <!-- Goalie specific columns -->
              <ng-container *ngIf="selectedCategory === 'goalieWins'">
                <th
                  (click)="sortBy('reg_gaa')"
                  [class.sorted]="sortKey === 'reg_gaa'"
                  class="stat-column"
                >
                  PMK
                  <span *ngIf="sortKey === 'reg_gaa'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_save_pct')"
                  [class.sorted]="sortKey === 'reg_save_pct'"
                  class="stat-column"
                >
                  T%
                  <span *ngIf="sortKey === 'reg_save_pct'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_shutouts')"
                  [class.sorted]="sortKey === 'reg_shutouts'"
                  class="stat-column"
                >
                  NP
                  <span *ngIf="sortKey === 'reg_shutouts'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
                <th
                  (click)="sortBy('reg_wins')"
                  [class.sorted]="sortKey === 'reg_wins'"
                  class="stat-column"
                >
                  V
                  <span *ngIf="sortKey === 'reg_wins'">{{
                    sortAsc ? "â–²" : "â–¼"
                  }}</span>
                </th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let player of filteredPlayers"
              (click)="selectPlayer(player)"
              class="player-row"
              [class.locked]="deadlinePassed"
            >
              <td>{{ player?.position || "" }}</td>
              <td>{{ player?.firstName || "" }}</td>
              <td>{{ player?.lastName || "" }}</td>
              <td>{{ player?.team || "" }}</td>
              <td class="stat-column">{{ player?.reg_gp || 0 }}</td>

              <!-- Skater stats (only shown when not viewing goalies) -->
              <ng-container *ngIf="selectedCategory !== 'goalieWins'">
                <td class="stat-column">
                  {{ getGoals(player) }}
                </td>
                <td class="stat-column">
                  {{ getAssists(player) }}
                </td>
                <td class="stat-column">
                  {{ getPoints(player) }}
                </td>
                <td
                  class="stat-column"
                  [class.positive]="getPlusMinus(player) > 0"
                  [class.negative]="getPlusMinus(player) < 0"
                >
                  {{ getPlusMinus(player) > 0 ? "+" : ""
                  }}{{ getPlusMinus(player) }}
                </td>
              </ng-container>

              <!-- Goalie stats (only shown when viewing goalies) -->
              <ng-container *ngIf="selectedCategory === 'goalieWins'">
                <td class="stat-column">
                  {{ getGaa(player) }}
                </td>
                <td class="stat-column">
                  {{ getSavePct(player) }}
                </td>
                <td class="stat-column">
                  {{ getShutouts(player) }}
                </td>
                <td class="stat-column">
                  {{ getWins(player) }}
                </td>
              </ng-container>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Global action buttons -->
  <div class="action-buttons-container">
    <button
      class="prediction-button save"
      (click)="savePredictions()"
      [disabled]="deadlinePassed"
    >
      <span *ngIf="!deadlinePassed">
        <span class="desktop-text">ðŸ’¾ Tallenna kaikki veikkaukset</span>
        <span class="mobile-text">ðŸ’¾ Tallenna</span>
      </span>
      <span *ngIf="deadlinePassed">ðŸ”’ Veikkaukset lukittu</span>
    </button>
    <button
      class="prediction-button reset"
      (click)="resetPredictions()"
      [disabled]="deadlinePassed"
    >
      <span class="desktop-text">ðŸ”„ Nollaa veikkaukset</span>
      <span class="mobile-text">ðŸ”„ Nollaa</span>
    </button>
    <button
      class="prediction-button load"
      (click)="loadPredictions()"
      [disabled]="deadlinePassed"
    >
      <span class="desktop-text">ðŸ“‚ Lataa tallennetut veikkaukset</span>
      <span class="mobile-text">ðŸ“‚ Lataa</span>
    </button>
  </div>
</div>
